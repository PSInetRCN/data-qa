---
title: "README"
author: "Renata"
date: "`r Sys.Date()`"
output: github_document
---

This repo houses scripts for QA of PSInet data.

## Current status

```{r, include = F, echo = F}
library(boxr)
library(dplyr)
library(ggplot2)

source(here::here("general-scripts", "box_auth.R"))

tracking_data <- box_read_excel("1426404123641", sheet = 1)

tracking_data <- tracking_data |>
  mutate(across(contains("completed_checks"), .f = (\(x) ifelse(is.na(x), 0, x)))) 

check_key <- data.frame(
  check_code = c(0, 1, 2),
  check_status = c("Not started", "Completed", "Completed with errors")
)


checks0 <- tracking_data |>
  tally() |> 
  mutate(check_code = 1) |>
  left_join(check_key) |>
  mutate(check_level = "Check 0: Data submitted")
  
checks1 <- tracking_data |>
  group_by(completed_checks_1) |>
  tally() |>
  rename(check_code = completed_checks_1) |>
  left_join(check_key) |>
  mutate(check_level = "Check 1: Data imported")
checks2 <- tracking_data |>
  group_by(completed_checks_2) |>
  tally() |>
  rename(check_code = completed_checks_2) |>
  left_join(check_key) |>
  mutate(check_level = "Check 2: Study design and variables")
checks <- bind_rows(checks0, checks1, checks2)


theme_set(theme_minimal())

```

```{r, echo = F, fig.dim = c(6,4)}

ggplot(checks, aes(check_level, n, fill = check_status)) +
  geom_col(position = "stack") +
  ggtitle("Dataset statuses"
  ) +
  xlab("Stage") +
  ylab("Number of datasets") +
  theme(legend.position = "bottom") +
  scale_fill_viridis_d(option = "mako", begin = .2, end = .8) +
  geom_label(aes(label = n), fill = "white", position = "stack")

```

# Data QA instructions


## Data intake 

1. A data contributor uploads their data to Box and fills in the form at <https://viz.datascience.arizona.edu/psinet-data-submission>. 
1. Their survey responses get sent to the `datasheet_responses` data frame in Posit Connect.
1. Within a day, Renata will be notified of their response via an emailed .Rmd from Posit Connect.
 
## Set up infrastructure

1. Renata runs `general_scripts/template_data/01_update_submission_data.R` to update `submission_survey_responses.xlsx` on Box with the survey data from Posit Connect.
1. Renata runs `general_scripts/template_data/02_add_dataset_identifiers.R` to set up the box folders for any new datasets and update `dataset_tracking.xlsx` on Box.

## Ingest data

1. For each dataset, open `dataset_scripts/01_copy_sheets_and_check_types.R` and save-as to create a new script for this dataset.
1. Modify this script to read in each sheet from the new dataset, check that it has the right dims, set the column types, and save it as a series of .csv files in box.

## Check data

1. Run `checks/01-csvs-and-types.R` for each new dataset. This checks that the expected .csv files exist and that they have the expected data types. If there are any errors they will show up in `errors_list` and will be saved to box as `errors_01.csv`. *Either update the data ingestion script or work with the authors to resolve any errors*.
1. Run `checks/02-design-and-variables.R`. This checks that the experimental design is internally consistent and that all expected data variables are provided. If there are any errors they will show up in `errors_list` and will be saved to box as `errors_02.csv`. *Either update the data ingestion script or work with the authors to resolve any errors*.

For both data checking steps: If you modify the data ingestion script to make substantive changes to the data as they come in - e.g. changing IDs, changing NAs to FALSE, etc - add these to a 'notes' data frame at the end of the data ingestion script and write this to a file named `changes.txt` on box. There is code in the data ingestion script to do this.

When the check scripts are run, `dataset_tracking.xlsx` on Box will be updated. The columns `completed_checks_1` and `completed_checks_2` will be updated to `1` if the check script runs without errors and to `2` if the check script ran with errors. 